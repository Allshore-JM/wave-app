<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOAA GFS Wave Table View</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" integrity="sha384-9ndCyUaKqkl9xnk7h1Jw5mAkFp1ghn0Lffwku0a71uMRt9IyZ9L+9xpoda+Ek5QA" crossorigin="anonymous">
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-pjM6iBbF2pZGvUL/jBz8ZMCAU8EK6H65bohg4Mkg/m0=" crossorigin="" />
</head>
<body class="p-4">
    <h1 class="mb-4">NOAA GFS Wave Table View</h1>

    <!-- Map container for buoy selection -->
    <div id="map" style="height: 500px; margin-bottom: 1rem;"></div>
    <!-- Fallback buoy selection form (in case the map fails to load or for manual selection) -->
    <form method="POST" class="mb-3">
        <div class="row g-3 align-items-center">
            <!-- Station dropdown -->
            <div class="col-auto">
                <label for="station" class="col-form-label">Select Buoy:</label>
            </div>
            <div class="col-auto">
                <select id="station" name="station" class="form-select" style="min-width: 240px;">
                    {% for sid, name in stations %}
                        <option value="{{ sid }}" {% if sid == selected_station %}selected{% endif %}>
                            {{ sid }} - {{ name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <!-- Time zone dropdown -->
            <div class="col-auto">
                <label for="tz" class="col-form-label">Time Zone:</label>
            </div>
            <div class="col-auto">
                <select id="tz" name="tz" class="form-select" style="min-width: 200px;">
                    {% for tz in timezones %}
                        <option value="{{ tz }}" {% if tz == selected_tz %}selected{% endif %}>{{ tz }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Get Latest Data</button>
            </div>
        </div>
    </form>

    <!-- Display error message if one exists -->
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Display table and download link if data is available -->
    {% if table_html %}
        <div class="mb-3">
            <!-- Include the timezone query parameter in the download URL so the Excel file uses the same timezone -->
            <a href="{{ url_for('download', station_id=selected_station) }}{% if selected_tz %}?tz={{ selected_tz }}{% endif %}" class="btn btn-success">Download as Excel</a>
        </div>
        <div class="table-responsive">
            {{ table_html | safe }}
        </div>
    {% endif %}

    <!-- Leaflet JS for interactive map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o6RZnwF5zYNUG9mhOUGwwhVOeR2A7+2jztmmsmRF6G0=" crossorigin=""></script>
    <script>
        /*
         * Initialize the Leaflet map immediately.  The script is placed at
         * the end of the body, so the DOM elements (including #map) are
         * already available.  Wrapping this code in a DOMContentLoaded handler
         * prevented execution because the event had already fired by the time
         * the script loaded, resulting in no map being displayed.
         */
        var map = L.map('map');
        // Load OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 6,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        // Fetch station metadata asynchronously from the /stations.json endpoint.  This
        // avoids embedding a very large JSON object directly into the HTML.  Once
        // the data is loaded, markers are created for each station with valid
        // coordinates.  The map view is adjusted to encompass all markers.
        var markers = [];
        fetch('/stations.json')
            .then(function(response) {
                return response.json();
            })
            .then(function(stations) {
                stations.forEach(function(s) {
                    if (!isNaN(s.lat) && !isNaN(s.lon)) {
                        var marker = L.marker([s.lat, s.lon]).addTo(map);
                        marker.bindPopup('<strong>' + s.id + '</strong><br/>' + s.name);
                        marker.on('click', function() {
                            // When a marker is clicked, redirect to the station page with the
                            // currently selected timezone.  If the timezone dropdown is
                            // present, use its value; otherwise fall back to the empty string.
                            var tzSelect = document.getElementById('tz');
                            var tzVal = '';
                            if (tzSelect) {
                                tzVal = tzSelect.value;
                            }
                            var url = '/?station=' + encodeURIComponent(s.id);
                            if (tzVal) {
                                url += '&tz=' + encodeURIComponent(tzVal);
                            }
                            window.location.href = url;
                        });
                        markers.push(marker);
                    }
                });
                if (markers.length > 0) {
                    var group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.2));
                } else {
                    map.setView([0, 0], 2);
                }
            })
            .catch(function(err) {
                console.error('Failed to load station metadata:', err);
                // Fallback: show the world view if station data cannot be loaded
                map.setView([0, 0], 2);
            });
    </script>

    <!-- Bootstrap JS (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldmvZR3f3H3VFv5a5Y5nE1Wh6c5teEYkz1iGQCe" crossorigin="anonymous"></script>
</body>
</html>