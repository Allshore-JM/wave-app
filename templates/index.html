<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="p-4">
    <!-- Intentionally blank heading removed to satisfy request -->

    <!-- Map container for buoy selection -->
    <div id="map" style="height: 500px; margin-bottom: 1rem; overflow:hidden;"></div>
    <!-- Fallback buoy selection form (in case the map fails to load or for manual selection) -->
    <form method="POST" class="mb-3">
        <div class="row g-3 align-items-center">
            <!-- Station dropdown -->
            <div class="col-auto">
                <label for="station" class="col-form-label">Select Buoy:</label>
            </div>
            <div class="col-auto">
                <select id="station" name="station" class="form-select" style="min-width: 240px;">
                    {% for sid, name in stations %}
                        <option value="{{ sid }}" {% if sid == selected_station %}selected{% endif %}>
                            {{ sid }} - {{ name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <!-- Time zone dropdown -->
            <div class="col-auto">
                <label for="tz" class="col-form-label">Time Zone:</label>
            </div>
            <div class="col-auto">
                <select id="tz" name="tz" class="form-select" style="min-width: 200px;">
                    {% for tz in timezones %}
                        <option value="{{ tz }}" {% if tz == selected_tz %}selected{% endif %}>{{ tz }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Units dropdown -->
            <div class="col-auto">
                <label for="unit" class="col-form-label">Units:</label>
            </div>
            <div class="col-auto">
                <select id="unit" name="unit" class="form-select" style="min-width: 120px;">
                    {% for u in units %}
                        <option value="{{ u }}" {% if u == selected_unit %}selected{% endif %}>{{ "Metric" if u == "Metric" else "US" }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <!-- Renamed button label from "Get Latest Data" to "Update" as requested -->
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </div>
    </form>

    <!-- Display error message if one exists -->
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Display table if data is available -->
    {% if table_html %}
        <div class="table-responsive">
            {{ table_html | safe }}
        </div>
    {% endif %}

    <!-- Leaflet JS for interactive map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the Leaflet map immediately.  The script is placed at
        // the end of the body, so the DOM elements (including #map) are
        // already available.
        var map = L.map('map', {
            worldCopyJump: false,
            noWrap: true,
            minZoom: 2,
            maxZoom: 19,
            maxBoundsViscosity: 1.0
        });
        // Use the Esri World Imagery tile layer for a satellite basemap.
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri & contributors',
            maxZoom: 19,
            noWrap: true
        }).addTo(map);
        // Restrict panning to a single complete world.  Crop out Antarctica
        // and the top of the map by limiting latitude to roughly –60 to +85 degrees.
        map.setMaxBounds([[-60, -180], [85, 180]]);

        // Selected station coordinates and ID passed from the server.  If
        // ``selected_lat`` or ``selected_lon`` are null, then no marker
        // will be drawn and the map will remain centered on the default view.
        var selectedLat = {{ selected_lat if selected_lat is not none else 'null' }};
        var selectedLon = {{ selected_lon if selected_lon is not none else 'null' }};
        var selectedStationId = "{{ selected_station }}";

        // Function to add a single marker for the selected station.  When
        // clicked, the marker will redirect to the same page (refresh) with
        // the current timezone and unit selections preserved.
        function addSelectedMarker(lat, lon, stationId) {
            // Define a smaller icon for markers to improve presentation when zoomed out.
            var smallIcon = L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                iconSize: [15, 25],
                iconAnchor: [7.5, 25],
                popupAnchor: [0, -25],
                tooltipAnchor: [0, -20]
            });
            var marker = L.marker([lat, lon], {icon: smallIcon}).addTo(map);
            marker.bindTooltip(stationId, {permanent: false, direction: 'top'});
            marker.bindPopup('<strong>' + stationId + '</strong>');
            marker.on('click', function() {
                var tzSelect = document.getElementById('tz');
                var tzVal = tzSelect ? tzSelect.value : '';
                var unitSelect = document.getElementById('unit');
                var unitVal = unitSelect ? unitSelect.value : '';
                var url = '/?station=' + encodeURIComponent(stationId);
                if (tzVal) {
                    url += '&tz=' + encodeURIComponent(tzVal);
                }
                if (unitVal) {
                    url += '&unit=' + encodeURIComponent(unitVal);
                }
                window.location.href = url;
            });
        }

        // If coordinates are provided, center the map on the selected station
        // and add a marker; otherwise, default to a broad view centered on
        // the Pacific Ocean.
        if (selectedLat !== null && selectedLon !== null) {
            addSelectedMarker(selectedLat, selectedLon, selectedStationId);
            map.setView([selectedLat, selectedLon], 6);
        } else {
            // Default view if no station is selected or coordinates are unknown
            map.setView([0, 0], 2);
        }
    </script>

    <!-- Bootstrap JS (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
