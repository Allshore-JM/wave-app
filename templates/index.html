<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Wave App</title>

    <!-- Bootstrap (for layout + the table HTML) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      /* Map fills most of the viewport height */
      #map {
        width: 100%;
        height: 70vh; /* adjust if you want more/less map height */
      }

      /* Avoid light gray while tiles load */
      .leaflet-container {
        background: #000;
      }
    </style>
  </head>
  <body>
    <!-- Controls -->
    <div class="container-fluid py-2">
      <form id="controls" method="POST" class="row g-2 align-items-end">
        <div class="col-sm-3 col-md-2">
          <label class="form-label" for="station">Station</label>
          <select class="form-select" name="station" id="station">
            {% for sid, name in stations %}
            <option
              value="{{ sid }}"
              {% if sid == selected_station %}selected{% endif %}
            >
              {{ name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-sm-4 col-md-3">
          <label class="form-label" for="tz">Time zone</label>
          <select class="form-select" name="tz" id="tz">
            <!-- Empty value means "use buoy's local timezone" on the server -->
            <option value="">(Buoy local)</option>
            {% for tz in timezones %}
            <option value="{{ tz }}" {% if tz == selected_tz %}selected{% endif %}>
              {{ tz }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-sm-2 col-md-2">
          <label class="form-label" for="unit">Units</label>
          <select class="form-select" name="unit" id="unit">
            {% for u in units %}
            <option value="{{ u }}" {% if u == selected_unit %}selected{% endif %}>
              {{ u }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-sm-2 col-md-2">
          <button type="submit" class="btn btn-primary w-100">Update</button>
        </div>
      </form>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Table / Errors -->
    <div class="container-fluid py-3">
      {% if error %}
      <div class="alert alert-warning">{{ error }}</div>
      {% endif %}
      <div id="table-slot">
        {% if table_html %}
        {{ table_html|safe }}
        {% endif %}
      </div>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      (function () {
        // --- Single-world configuration (no wrap) to eliminate gray sidebands ---
        const WORLD_BOUNDS = L.latLngBounds([[-85, -180], [85, 180]]);

        const tiles = L.tileLayer(
          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
          {
            attribution: "Tiles Â© Esri & contributors",
            noWrap: true,
            maxZoom: 19
          }
        );

        const map = L.map("map", {
          layers: [tiles],
          noWrap: true,            // one copy of the world only
          worldCopyJump: false,
          maxBounds: WORLD_BOUNDS, // hard pan limits
          maxBoundsViscosity: 1.0,
          zoomControl: true
        });

        // Fit exactly one world to the current viewport and lock the min zoom
        function enforceWorldFit(keepCenter) {
          const center = keepCenter ? map.getCenter() : null;
          const minZ = map.getBoundsZoom(WORLD_BOUNDS, true);
          map.fitBounds(WORLD_BOUNDS, { padding: [0, 0] });
          map.setMinZoom(minZ);
          if (map.getZoom() < minZ) map.setZoom(minZ);
          if (keepCenter && center) {
            map.setView(center, Math.max(map.getZoom(), minZ), { animate: false });
          }
          map.setMaxBounds(WORLD_BOUNDS);
        }

        enforceWorldFit(false);
        window.addEventListener("resize", () => enforceWorldFit(true));

        // --- Station markers (yellow) ---
        const markerLayer = L.layerGroup().addTo(map);
        const formEl = document.getElementById("controls");
        const stationSel = document.getElementById("station");
        const tzSel = document.getElementById("tz");

        // When user changes the station via dropdown:
        // Clear tz to "", so the server uses the buoy's local timezone
        if (stationSel) {
          stationSel.addEventListener("change", () => {
            if (tzSel) tzSel.value = ""; // use buoy local
            formEl?.submit();
          });
        }

        fetch("/stations.json")
          .then((r) => r.json())
          .then((stations) => {
            stations.forEach((st) => {
              if (typeof st.lat === "number" && typeof st.lon === "number") {
                L.circleMarker([st.lat, st.lon], {
                  radius: 4,
                  color: "#FFD400",
                  weight: 2,
                  fillColor: "#FFD400",
                  fillOpacity: 1.0
                })
                  .bindPopup(`${st.name} (${st.id})`)
                  .on("click", () => {
                    if (stationSel) stationSel.value = st.id;
                    // Clear tz to signal "use buoy local" for the selected station
                    if (tzSel) tzSel.value = "";
                    formEl?.submit();
                  })
                  .addTo(markerLayer);
              }
            });
          })
          .catch(() => {});

        // If server provided a selected buoy position, center on it without violating min zoom
        {% if selected_lat is not none and selected_lon is not none %}
        (function () {
          const lat = {{ selected_lat|tojson }};
          const lon = {{ selected_lon|tojson }};
          const targetZ = Math.max(map.getZoom(), 6); // zoom in while respecting minZoom
          map.setView([lat, lon], targetZ);
        })();
        {% endif %}
      })();
    </script>
  </body>
</html>
