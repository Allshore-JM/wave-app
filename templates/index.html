<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allshore Surf</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="p-4">
    <h1 class="mb-4">Allshore Surf</h1>

    <!-- Map container for buoy selection -->
    <div id="map" style="height: 500px; margin-bottom: 1rem; overflow:hidden;"></div>
    <!-- Fallback buoy selection form (in case the map fails to load or for manual selection) -->
    <form method="POST" class="mb-3">
        <div class="row g-3 align-items-center">
            <!-- Station dropdown -->
            <div class="col-auto">
                <label for="station" class="col-form-label">Select Buoy:</label>
            </div>
            <div class="col-auto">
                <select id="station" name="station" class="form-select" style="min-width: 240px;">
                    {% for sid, name in stations %}
                        <option value="{{ sid }}" {% if sid == selected_station %}selected{% endif %}>
                            {{ sid }} - {{ name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <!-- Time zone dropdown -->
            <div class="col-auto">
                <label for="tz" class="col-form-label">Time Zone:</label>
            </div>
            <div class="col-auto">
                <select id="tz" name="tz" class="form-select" style="min-width: 200px;">
                    {% for tz in timezones %}
                        <option value="{{ tz }}" {% if tz == selected_tz %}selected{% endif %}>{{ tz }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Units dropdown -->
            <div class="col-auto">
                <label for="unit" class="col-form-label">Units:</label>
            </div>
            <div class="col-auto">
                <select id="unit" name="unit" class="form-select" style="min-width: 120px;">
                    {% for u in units %}
                        <option value="{{ u }}" {% if u == selected_unit %}selected{% endif %}>{{ "Metric" if u == "Metric" else "US" }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Get Latest Data</button>
            </div>
        </div>
    </form>

    <!-- Display error message if one exists -->
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Display table if data is available -->
    {% if table_html %}
        <div class="table-responsive">
            {{ table_html | safe }}
        </div>
    {% endif %}

    <!-- Leaflet JS for interactive map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the Leaflet map immediately.  The script is placed at
        // the end of the body, so the DOM elements (including #map) are
        // already available.
        var map = L.map('map');
        // Use an Esri satellite imagery tile layer.  The noWrap option
        // prevents the world from repeating horizontally, and maxZoom
        // allows closer zooming for more detail.
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles Â© Esri & contributors',
            maxZoom: 19,
            noWrap: true
        }).addTo(map);
        // Restrict panning to a single copy of the world and crop out Antarctica.
        map.setMaxBounds([[-60, -180], [85, 180]]);

        // Array to hold markers
        var markers = [];
        // Fetch station metadata asynchronously from the /stations.json endpoint.  Once
        // loaded, create a marker for each station.  Tooltips display the station
        // ID on hover, and clicking a marker redirects to the table view for that
        // station using the currently selected timezone and unit values.
        fetch('/stations.json')
            .then(function(response) {
                return response.json();
            })
            .then(function(stations) {
                stations.forEach(function(s) {
                    if (!isNaN(s.lat) && !isNaN(s.lon)) {
                        // Define a smaller icon for markers to improve presentation when zoomed out.
                        var smallIcon = L.icon({
                            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                            iconSize: [15, 25],
                            iconAnchor: [7.5, 25],
                            popupAnchor: [0, -25],
                            tooltipAnchor: [0, -20]
                        });
                        var marker = L.marker([s.lat, s.lon], {icon: smallIcon}).addTo(map);
                        // Display station ID on hover
                        marker.bindTooltip(s.id, {permanent: false, direction: 'top'});
                        // Show a popup with station ID and name when clicked
                        marker.bindPopup('<strong>' + s.id + '</strong><br/>' + s.name);
                        marker.on('click', function() {
                            var tzSelect = document.getElementById('tz');
                            var tzVal = '';
                            if (tzSelect) {
                                tzVal = tzSelect.value;
                            }
                            var unitSelect = document.getElementById('unit');
                            var unitVal = '';
                            if (unitSelect) {
                                unitVal = unitSelect.value;
                            }
                            var url = '/?station=' + encodeURIComponent(s.id);
                            if (tzVal) {
                                url += '&tz=' + encodeURIComponent(tzVal);
                            }
                            if (unitVal) {
                                url += '&unit=' + encodeURIComponent(unitVal);
                            }
                            window.location.href = url;
                        });
                        markers.push(marker);
                    }
                });
                if (markers.length > 0) {
                    var group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.2));
                } else {
                    map.setView([0, 0], 2);
                }
            })
            .catch(function(err) {
                console.error('Failed to load station metadata:', err);
                map.setView([0, 0], 2);
            });
    </script>

    <!-- Bootstrap JS (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
