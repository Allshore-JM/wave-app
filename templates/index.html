<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Wave Forecast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap (for table/controls) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <style>
    html, body { height: 100%; }
    #map { height: 420px; border: 1px solid #ccc; }
    .leaflet-tooltip { font-weight: 600; }
    .sticky-top-bar { position: sticky; top: 0; z-index: 1000; background:#fff; border-bottom: 1px solid #eee; }
    .form-inline .form-select, .form-inline .form-control { width: auto; }
  </style>
</head>
<body class="bg-light">

  <div class="container-fluid py-3">
    <div class="sticky-top-bar pb-2">
      <form id="controlForm" class="row g-2 align-items-center">
        <div class="col-auto">
          <label for="station" class="form-label mb-0">Station</label>
          <select class="form-select" id="station" name="station">
            {% for sid, name in stations %}
              <option value="{{ sid }}" {% if sid == selected_station %}selected{% endif %}>{{ sid }} — {{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <label for="tz" class="form-label mb-0">Time Zone</label>
          <select class="form-select" id="tz" name="tz">
            <option value="">(Buoy Local)</option>
            {% for tz in timezones %}
              <option value="{{ tz }}" {% if tz == selected_tz %}selected{% endif %}>{{ tz }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <label for="unit" class="form-label mb-0">Units</label>
          <select class="form-select" id="unit" name="unit">
            {% for u in units %}
              <option value="{{ u }}" {% if u == selected_unit %}selected{% endif %}>{{ u }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <label for="view" class="form-label mb-0">View</label>
          <select class="form-select" id="view" name="view">
            <option value="Table" {% if selected_view == 'Table' %}selected{% endif %}>Table</option>
            <option value="Graph" {% if selected_view == 'Graph' %}selected{% endif %}>Graph</option>
          </select>
        </div>
        <div class="col-auto">
          <a id="dlLink" class="btn btn-outline-primary"
             href="/download/{{ selected_station }}?tz={{ selected_tz }}&unit={{ selected_unit }}">Download Excel</a>
        </div>
      </form>
    </div>

    <div class="row mt-2">
      <div class="col-12">
        <div id="map"></div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-12">
        {% if error %}
          <div class="alert alert-warning">{{ error }}</div>
        {% endif %}

        {% if selected_view == 'Graph' %}
          <!-- Graph View -->
          <div id="graphs" class="card">
            <div class="card-body">
              <h5 class="card-title mb-3">Graphs ({{ graph_data.units }})</h5>
              <div class="mb-4">
                <canvas id="heightChart" height="140"></canvas>
              </div>
              <div class="mb-4">
                <canvas id="periodChart" height="140"></canvas>
              </div>
              <div>
                <canvas id="directionChart" height="140"></canvas>
              </div>
            </div>
          </div>
        {% else %}
          <!-- Table View -->
          <div id="tableWrap" class="card">
            <div class="card-body">
              {{ table_html|safe }}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    // ---- Keep map zoom/center between requests ----
    const mapKey = 'mapView';
    function saveMapView(map) {
      const v = {c: map.getCenter(), z: map.getZoom()};
      sessionStorage.setItem(mapKey, JSON.stringify({lat: v.c.lat, lng: v.c.lng, z: v.z}));
    }
    function loadMapView() {
      try { return JSON.parse(sessionStorage.getItem(mapKey)); } catch(e) { return null; }
    }

    // ---- Leaflet Map ----
    const map = L.map('map', { worldCopyJump: false, zoomControl: true });
    const saved = loadMapView();
    if (saved) {
      map.setView([saved.lat, saved.lng], saved.z);
    } else {
      map.setView([20, -160], 2); // initial view
    }

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 8,
      minZoom: 2,
      noWrap: true
    }).addTo(map);

    // Plot stations
    fetch('/stations.json')
      .then(r => r.json())
      .then(stations => {
        stations.forEach(s => {
          const mk = L.circleMarker([s.lat, s.lon], {
            radius: 2,           // smaller yellow markers
            color: '#FFD600',
            fillColor: '#FFD600',
            fillOpacity: 1,
            weight: 1
          }).addTo(map);
          // Tooltip: station ID on hover
          mk.bindTooltip(s.id, {permanent: false, direction: 'top', offset: [0, -2]});
          // Click to select station; keep zoom state
          mk.on('click', () => {
            document.getElementById('station').value = s.id;
            saveMapView(map);
            document.getElementById('controlForm').submit();
          });
        });
      });

    // Keep map state on any control change
    ['station','tz','unit','view'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('change', () => {
        saveMapView(map);
        // Update Excel link on-the-fly too
        if (id === 'station' || id === 'tz' || id === 'unit') {
          const st = document.getElementById('station').value;
          const tz = document.getElementById('tz').value;
          const un = document.getElementById('unit').value;
          document.getElementById('dlLink').href = `/download/${st}?tz=${encodeURIComponent(tz)}&unit=${encodeURIComponent(un)}`;
        }
        document.getElementById('controlForm').submit();
      });
    });

    // ---- Charts ----
    {% if selected_view == 'Graph' and graph_data %}
    const GD = {{ graph_data|tojson|safe }};

    // Palette (matches table headers / PDF)
    const colors = {
      s1: '#C00000',
      s2: '#ED7D31',
      s3: '#FFC000',
      s4: '#00B050',
      s5: '#00B0F0',
      s6: '#92D050',
      combined: '#7030A0'
    };

    const commonOpts = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'category',
          ticks: { maxRotation: 60, minRotation: 60 },
          grid: { display: true }
        },
        y: {
          beginAtZero: true,
          grid: { display: true }
        }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { mode: 'nearest', intersect: false }
      },
      elements: { point: { radius: 2 }, line: { tension: 0.3 } }
    };

    function swellLine(label, key, data, color, showLine=true) {
      return {
        label: label,
        data: data[key],
        borderColor: color,
        backgroundColor: color,
        spanGaps: true,
        showLine: showLine
      };
    }

    // HEIGHT (ft/m) — includes Combined
    (() => {
      const ds = [
        swellLine('Swell 1', 's1', GD.height, colors.s1),
        swellLine('Swell 2', 's2', GD.height, colors.s2),
        swellLine('Swell 3', 's3', GD.height, colors.s3),
        swellLine('Swell 4', 's4', GD.height, colors.s4),
        swellLine('Swell 5', 's5', GD.height, colors.s5),
        swellLine('Swell 6', 's6', GD.height, colors.s6),
        {
          label: 'Combined',
          data: GD.height.combined,
          borderColor: colors.combined,
          backgroundColor: colors.combined,
          spanGaps: true,
          borderWidth: 2,
          pointRadius: 1.5,
          tension: 0.25
        }
      ];
      const ctx = document.getElementById('heightChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels: GD.labels, datasets: ds },
        options: {
          ...commonOpts,
          plugins: { ...commonOpts.plugins, title: { display: true, text: 'Swell Height' } },
          scales: { ...commonOpts.scales, y: { ...commonOpts.scales.y, title: { display: true, text: `Height (${GD.units})` } } }
        }
      });
    })();

    // PERIOD (s)
    (() => {
      const ds = [
        swellLine('Swell 1', 's1', GD.period, colors.s1),
        swellLine('Swell 2', 's2', GD.period, colors.s2),
        swellLine('Swell 3', 's3', GD.period, colors.s3),
        swellLine('Swell 4', 's4', GD.period, colors.s4),
        swellLine('Swell 5', 's5', GD.period, colors.s5),
        swellLine('Swell 6', 's6', GD.period, colors.s6)
      ];
      const ctx = document.getElementById('periodChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels: GD.labels, datasets: ds },
        options: {
          ...commonOpts,
          plugins: { ...commonOpts.plugins, title: { display: true, text: 'Swell Period' } },
          scales: { ...commonOpts.scales, y: { ...commonOpts.scales.y, title: { display: true, text: 'Period (s)' } } }
        }
      });
    })();

    // DIRECTION (deg)
    (() => {
      const ds = [
        swellLine('Swell 1', 's1', GD.direction, colors.s1),
        swellLine('Swell 2', 's2', GD.direction, colors.s2),
        swellLine('Swell 3', 's3', GD.direction, colors.s3),
        swellLine('Swell 4', 's4', GD.direction, colors.s4),
        swellLine('Swell 5', 's5', GD.direction, colors.s5),
        swellLine('Swell 6', 's6', GD.direction, colors.s6),
      ];
      const ctx = document.getElementById('directionChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels: GD.labels, datasets: ds },
        options: {
          ...commonOpts,
          plugins: { ...commonOpts.plugins, title: { display: true, text: 'Swell Direction' } },
          scales: {
            ...commonOpts.scales,
            y: { ...commonOpts.scales.y, suggestedMin: 0, suggestedMax: 360, title: { display: true, text: 'Direction (°)' } }
          }
        }
      });
    })();
    {% endif %}
  </script>
</body>
</html>
